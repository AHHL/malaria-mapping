<!DOCTYPE html>
<html>
<head>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <meta charset=utf-8 />
  <title>Malaria Mapping</title>
  <link href='https://www.mapbox.com/base/latest/base.css' rel='stylesheet' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.36.0/mapbox-gl.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.36.0/mapbox-gl.css' rel='stylesheet' />
  <style>
  body {
    margin: 0;
    padding: 0;
  }

  #map {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
  }

  #buildings {
    color: rgba(19, 182, 238, 0.9);
  }

  #legend {
    color: rgba(0, 0, 0, 0.75);
  }

  .dark.button {
    background-color: rgba(0, 12, 26, 0.41);
  }

  .button:hover, .button.active {
    background-color: #52a1d8;
  }

  .fill-bg {
    background-color: rgb(47, 48, 54);
  }

  .fill-control {
    background-color: #505050;
  }

  .flag {
    display: inline;
    max-width: 30px;
  }

  .tourStop .button {
    display: inline-block;
    min-width: 120px;
    margin-right: 5px;
    margin-bottom: 10px;
    text-align: left;
  }

  .control-container {
    padding: 0 0 0 40px;
  }

  .playback {
    background-image: url(img/play.svg);
    background-color: transparent;
    background-repeat: no-repeat;
    width: 40px;
    height: 40px;
    border-color: rgba(0, 0, 0, 0.75);
  }

  .playback.pause {
    background-image: url(img/pause.svg);
  }

  .playback:hover {
    background-color: #373737;
  }

  .lifted {
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.20);
  }

  #counter {
    width: 100%;
  }

  .sidebar {
    position:absolute;
    top:0;
    bottom:0;
    width: 360px;
  }
  .sidebar-inner {
    display:-webkit-box;
    display:flex;
    -webkit-box-orient:vertical;
    flex-direction:column;
    height:100%;
  }
  .sidebar-inner .flex-scroll {
    overflow-y:scroll;
    min-height:0;
    -webkit-box-flex:1;
    flex:1;
  }
  </style>
</head>

<body>

<div id="sidebar" class="sidebar pin-topleft pin-bottomleft z1">
  <div class="sidebar-inner fill-bg dark round sidebar-inner">
    <div class="flex-scroll scroll-styled pad2" id="narrative">
      <h1>Eliminating Malaria through Mapping</h1>
      <p>
Volunteers from all over the world are contributing to eliminating Malaria by mapping buildings of the people in need.
      <a href="https://www.hotosm.org/projects/malaria_elimination_campaign" target="_blank" style="color: rgba(19, 182, 238, 0.9); text-decoration: underline;">Start mapping!</a>
      </p>
      <div id="counter" class="dark center pad1 col3">
        <div class="clearfix space-bottom">
          <div class="contain control-container round fill-control lifted">
            <button id="play-control" class="button playback play pin-bottomleft round-left keyline-right"></button>
            <div class="pad1y pad2x contain round-right">
              <input id="range" class="col12" type="range" min="0" max="294" step="1" value="0">
            </div>
          </div>
        </div>
        <h2 class="fancy" id="buildings">5012</h2>
        <h4>buildings mapped by</h4>
        <h3 class="fancy" id="time">01-07-16</h3>
      </div>

      <div class="tourStop">
        <h2>Mapping Projects</h2>
        <p>Over 1.5 million buildings have been mapped as part of the Malaria elimination campaign since 2016.</p>
        <div id="zambia" class="button fill-navy-dark dark">
          <img class="flag" src="img/zambia.png" alt="Zambia" />
          <span> Zambia</span>
        </div>
        <div id="botswana" class="button fill-navy-dark dark">
          <img class="flag" src="img/botswana.png" alt="Botswana" />
          <span> Botswana</span>
        </div>
        <div id="zimbabwe" class="button fill-navy-dark dark">
          <img class="flag" src="img/zimbabwe.png" alt="Zimbabwe" />
          <span> Zimbabwe</span>
        </div>
        <div id="laos" class="button fill-navy-dark dark">
          <img class="flag" src="img/laos.png" alt="Laos" />
          <span> Laos</span>
        </div>
        <div id="cambodia" class="button fill-navy-dark dark">
          <img class="flag" src="img/cambodia.png" alt="Cambodia" />
          <span> Cambodia</span>
        </div>
        <div id="honduras" class="button fill-navy-dark dark">
          <img class="flag" src="img/honduras.png" alt="Honduras" />
          <span> Honduras</span>
        </div>
        <div id="guatemala" class="button fill-navy-dark dark">
          <img class="flag" src="img/guatemala.png" alt="Guatemala" />
          <span> Guatemala</span>
        </div>
      </div>
    </div>
  </div>
</div>
  <div id="map"></div>
  <script>
  var mobile = document.documentElement.clientHeight <= 500;

  mapboxgl.accessToken = 'pk.eyJ1IjoibHVrYXNtYXJ0aW5lbGxpIiwiYSI6ImNqMXMyYTRuejAwOHkzM3Frbjg1ZW9kNnAifQ.F5tkdGnKJMv4yaYZNOTJ5w';
  window.map = new mapboxgl.Map({
    container: "map", // container id
    style: "mapbox://styles/lukasmartinelli/cj1rztb6o000g2st2zlb7mp7t", //stylesheet location
    center: [25.8499, -17.8597], // starting position
    zoom: 12,
    maxZoom: 14,
    minZoom: 1,
    hash: true
  });

  var sidebar = document.getElementById('sidebar');
  if (getQueryVariable('sidebar') === 'no') {
    sidebar.style.display = "none";
  }

  var playControl = document.getElementById('play-control');
  var range = document.getElementById('range');
  var time = document.getElementById('time');
  var buildings = document.getElementById('buildings');

  var startDate = new Date(2016, 6, 1);
  var tally = 0; // The current index in the layers array we are showing.
  var playback = false;
  var max = range.max;

  var dayStats = {};

  var styleByDay = throttle(function (day) {
    var layers = ['malaria-building-point', 'malaria-building-glow', 'malaria-building-shape'];
    var filter = ["<=", "@day", day];

    if (map.loaded()) {
      layers.forEach(function(layer) {
        map.setFilter(layer, filter);
      });
    }
  }, 400);

  var updateCounts = throttle(function(total, date) {
    buildings.innerHTML = total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    time.innerHTML = date.format('MMM D, YYYY');
  }, 150);

  function play(v) {
    range.value = v;
    var date = moment(startDate).add(range.value, 'days');

    var sum = 0;
    for(var d = 0; d <= v; d++) {
      sum += dayStats[d] || 0;
    }
    updateCounts(sum, date);
    styleByDay(v);

    // If range hit's the end show play button again
    if (parseInt(range.value) >= parseInt(range.max)) {
      clearPlayback();
    }
  }

  loadBuildingStats(function(stats) {
    dayStats = stats;
    map.on('load', function() {
      var day = parseInt(getQueryVariable('day'));
      var speed = parseInt(getQueryVariable('speed'));

      styleByDay(day || 0);
      playControl.addEventListener('click', setPlay);
      setTimeout(function() {
        range.value = day || 0;
        setPlay(speed || 50);
      }, 500);
    });
  });

  map.on('zoomend', function() {
    var zoom = map.getZoom();
    if(zoom <= 5) {
      setSpeed(50);
    }
  });

  // Add events.
  range.addEventListener('input', function() {
    if (playback) clearPlayback();
    play(parseInt(range.value, 10));
  });

  function loadBuildingStats(callback) {
    var xmlhttp;
    xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function(){
      if (xmlhttp.readyState == 4 && xmlhttp.status == 200){
        callback(JSON.parse(xmlhttp.responseText));
      }
    }
    xmlhttp.open("GET", "malaria_buildings_by_day.json", true);
    xmlhttp.send();
  }

  function clearPlayback() {
    window.clearInterval(playback);
    playControl.classList.remove('pause');
    playControl.classList.add('play');
    playback = false;
  }

  function setSpeed(speed) {
    console.log('Set speed', speed);
    clearPlayback();
    playback = window.setInterval(function() {
      var value = parseInt(range.value, 10);
      play(value + 1);
    }, speed);
  }

  function setPlay(speed) {
    if (parseInt(range.value) >= parseInt(range.max)) {
      range.value = 0;
    }

    speed = parseInt(speed) || 200;
    if (playback) return clearPlayback();
    playControl.classList.remove('play');
    playControl.classList.add('pause');
    playback = window.setInterval(function() {
      var value = parseInt(range.value, 10);
      play(value + 1);
    }, speed);
  }

  function throttle(fn, threshhold, scope) {
    threshhold || (threshhold = 250);
    var last,
        deferTimer;
    return function () {
      var context = scope || this;

      var now = +new Date,
          args = arguments;
      if (last && now < last + threshhold) {
        // hold on to it
        clearTimeout(deferTimer);
        deferTimer = setTimeout(function () {
          last = now;
          fn.apply(context, args);
        }, threshhold);
      } else {
        last = now;
        fn.apply(context, args);
      }
    };
  }

  function flyHandler(id, options) {
    var button = document.getElementById(id);
    button.addEventListener('click', function() {
      map.flyTo({
        center: options.center,
        zoom: options.zoom || 5
      });
      if (options.startDay) {
        console.log('Play from day', options.startDay);
        play(options.startDay);
      }
      if (options.speed) {
        setSpeed(options.speed);
      }
    });
  }

  flyHandler('botswana', {
    center: [22.966, -21.918],
    zoom: 5.5,
    startDay: 140,
    speed: 450
  });
  flyHandler('zambia', {
    center: [25.155, -13.605],
    startDay: 210,
    zoom: 5.5,
    speed: 450
  });
  flyHandler('zimbabwe', {
    center: [27.234, -19.072],
    zoom: 5.5,
    speed: 300
  });
  flyHandler('laos', {
    center: [105.9620, 16.6489],
    zoom: 8.4,
    startDay: 90,
    speed: 300
  });
  flyHandler('cambodia', {
    center: [104.5779, 11.8601],
    zoom: 7,
    startDay: 190,
    speed: 500
  });
  flyHandler('guatemala', {
    center: [-91.302, 15.225],
    startDay: 60,
    zoom: 7.5,
    speed: 500
  });
  flyHandler('honduras', {
    center: [-86.214, 15.330],
    zoom: 6.5,
    startDay: 190,
    speed: 500
  });

  function getQueryVariable(variable) {
      var query = window.location.search.substring(1);
      var vars = query.split('&');
      for (var i = 0; i < vars.length; i++) {
          var pair = vars[i].split('=');
          if (decodeURIComponent(pair[0]) == variable) {
              return decodeURIComponent(pair[1]);
          }
      }
      console.log('Query variable %s not found', variable);
  }

  </script>
</body>

</html>
