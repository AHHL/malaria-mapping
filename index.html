<!DOCTYPE html>
<html>
<head>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <meta charset=utf-8 />
  <title>Malaria Mapping</title>
  <link href='https://www.mapbox.com/base/latest/base.css' rel='stylesheet' />
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.36.0/mapbox-gl.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.36.0/mapbox-gl.css' rel='stylesheet' />
  <style>
  body {
    margin: 0;
    padding: 0;
  }

  #map {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
  }

  #buildings {
    color: rgba(19, 182, 238, 0.9);
  }

  #legend {
    color: rgba(0, 0, 0, 0.75);
  }

  .dark.button {
    background-color: rgba(0, 12, 26, 0.41);
  }

  .button:hover, .button.active {
    background-color: #52a1d8;
  }

  .fill-bg {
    background-color: rgb(47, 48, 54);
  }

  .fill-control {
    background-color: #505050;
  }

  .flag {
    display: inline;
    max-width: 30px;
  }

  .tourStop .button {
    display: inline-block;
    min-width: 120px;
    margin-right: 5px;
    margin-bottom: 10px;
    text-align: left;
  }

  .control-container {
    padding: 0 0 0 40px;
  }

  .playback {
    background-image: url(img/play.svg);
    background-color: transparent;
    background-repeat: no-repeat;
    width: 40px;
    height: 40px;
    border-color: rgba(0, 0, 0, 0.75);
  }

  .playback.pause {
    background-image: url(img/pause.svg);
  }

  .playback:hover {
    background-color: #373737;
  }

  .lifted {
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.20);
  }

  #counter {
    width: 100%;
  }

	.sidebar {
		position:absolute;
		top:0;
		bottom:0;
		width: 360px;
	}
	.sidebar-inner {
		display:-webkit-box;
		display:flex;
		-webkit-box-orient:vertical;
		flex-direction:column;
		height:100%;
	}
	.sidebar-inner .flex-scroll {
		overflow-y:scroll;
		min-height:0;
		-webkit-box-flex:1;
		flex:1;
	}
  </style>
</head>

<body>

<div class="sidebar pin-topleft pin-bottomleft z1">
  <div class="sidebar-inner fill-bg dark round sidebar-inner">
    <div class="flex-scroll scroll-styled pad2" id="narrative">
      <h1>Eliminating Malaria through Mapping</h1>
      <p>
By mapping buildings, volunteers from all over the world contributed to the map, directly contributing to malaria elimination efforts.
      </p>
      <div id="counter" class="dark center pad1 col3">
        <div class="clearfix space-bottom">
          <div class="contain control-container round fill-control lifted">
            <button id="play-control" class="button playback play pin-bottomleft round-left keyline-right"></button>
            <div class="pad1y pad2x contain round-right">
              <input id="range" class="col12" type="range" min="0" max="294" step="1" value="0">
            </div>
          </div>
        </div>
        <h2 class="fancy" id="buildings">5012</h2>
        <h4>buildings mapped by</h4>
        <h3 class="fancy" id="time">01-07-16</h3>
      </div>

      <div class="tourStop">
        <h2>Mapping Projects</h2>
        <p>Over 350'000 buildings have been mapped since 2016.</p>
        <div id="zimbabwe" class="button fill-navy-dark dark">
          <img class="flag" src="img/zimbabwe.png" alt="Zimbabwe" />
          <span> Zimbabwe</span>
        </div>
        <div id="zambia" class="button fill-navy-dark dark">
          <img class="flag" src="img/zambia.png" alt="Zambia" />
          <span> Zambia</span>
        </div>
        <div id="botswana" class="button fill-navy-dark dark">
          <img class="flag" src="img/botswana.png" alt="Botswana" />
          <span> Botswana</span>
        </div>
        <div id="laos" class="button fill-navy-dark dark">
          <img class="flag" src="img/laos.png" alt="Laos" />
          <span> Laos</span>
        </div>
        <div id="cambodia" class="button fill-navy-dark dark">
          <img class="flag" src="img/cambodia.png" alt="Cambodia" />
          <span> Cambodia</span>
        </div>
        <div id="honduras" class="button fill-navy-dark dark">
          <img class="flag" src="img/honduras.png" alt="Honduras" />
          <span> Honduras</span>
        </div>
        <div id="guatemala" class="button fill-navy-dark dark">
          <img class="flag" src="img/guatemala.png" alt="Guatemala" />
          <span> Guatemala</span>
        </div>
      </div>
    </div>
  </div>
</div>
  <div id="map"></div>
  <script>
  var mobile = document.documentElement.clientHeight <= 500;
  mapboxgl.accessToken = 'pk.eyJ1IjoibHVrYXNtYXJ0aW5lbGxpIiwiYSI6ImNqMXMyYTRuejAwOHkzM3Frbjg1ZW9kNnAifQ.F5tkdGnKJMv4yaYZNOTJ5w';
  window.map = new mapboxgl.Map({
    container: "map", // container id
    style: "mapbox://styles/lukasmartinelli/cj1rztb6o000g2st2zlb7mp7t", //stylesheet location
    center: [25.8499, -17.8597], // starting position
    zoom: 12,
    maxZoom: 14,
    hash: true
  });

  var playControl = document.getElementById('play-control');
  var range = document.getElementById('range');
  var time = document.getElementById('time');
  var buildings = document.getElementById('buildings');

  var startDate = new Date(2016, 6, 1);
  var tally = 0; // The current index in the layers array we are showing.
  var playback = false;
  var max = range.max;

  var dayStats = {};
  loadBuildingStats(function(stats) {
    map.on('load', function() {
      playControl.addEventListener('click', setPlay);
      dayStats = stats;
      styleByDay(0);
    });
  });
  // Trigger automation
  setPlay();

  function styleByDay(day) {
    var layers = ['malaria-building-point', 'malaria-building-glow', 'malaria-building-shape'];
    var filter = ["<=", "@day", day];
    layers.forEach(function(layer) {
      map.setFilter(layer, filter);
    })
    console.log('by day', day);
  }

  // Add events.
  range.addEventListener('input', function() {
    if (playback) clearPlayback();
    play(parseInt(range.value, 10));
  });

  function loadBuildingStats(callback) {
    var xmlhttp;
    xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange = function(){
      if (xmlhttp.readyState == 4 && xmlhttp.status == 200){
        callback(JSON.parse(xmlhttp.responseText));
      }
    }
    xmlhttp.open("GET", "/malaria_buildings_by_day.json", true);
    xmlhttp.send();
  }


  function clearPlayback() {
    window.clearInterval(playback);
    playControl.classList.remove('pause');
    playControl.classList.add('play');
    playback = false;
  }

  function setPlay() {
    if (playback) return clearPlayback();
    playControl.classList.remove('play');
    playControl.classList.add('pause');
    playback = window.setInterval(function() {
      var value = parseInt(range.value, 10);
      play(value + 1);
    }, 400);
  }

  function play(v) {
    range.value = v;
    const date = moment(startDate).add(range.value, 'days');

    var sum = 0;
    for(var d = 0; d <= v; d++) {
      sum += dayStats[d] || 0;
    }

    buildings.innerHTML = sum.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    time.innerHTML = date.format('MMM D, YYYY');
    styleByDay(v);
  }

  function flyHandler(id, options) {
    var button = document.getElementById(id);
    button.addEventListener('click', function() {
      map.flyTo({
        center: options.center,
        zoom: options.zoom || 5
      });
    });
    console.log(options.startDay);
  }

  flyHandler('botswana', {
    center: [22.966, -21.918]
  });
  flyHandler('zambia', {
    center: [25.155, -13.605]
  });
  flyHandler('zimbabwe', {
    center: [27.234, -19.072]
  });
  flyHandler('laos', {
    center: [105.015, 16.009]
  });
  flyHandler('cambodia', {
    center: [103.272, 13.745]
  });
  flyHandler('guatemala', {
    center: [-91.302, 15.225]
  });
  flyHandler('honduras', {
    center: [-86.214, 15.330]
  });
  </script>
</body>

</html>
